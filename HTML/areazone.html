<!-- <script type="text/javascript" src="../JS/homepage.js"> </script> -->
<!-- <link rel="stylesheet" href="../CSS/areazone.css"/> -->

<!DOCTYPE html>
<html>

<head>
    <title>Multiple routes by mode of travel - Azure Maps Web Control Samples</title>

    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="This tutorial shows how to perform multiple routes for different modes of travel and display them on the map." />
    <meta name="keywords" content="map, gis, API, SDK, services, module, tutorials, routing, directions, route, truck, commercial vehicle" />
    <meta name="author" content="Microsoft Azure Maps" />

    <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/css/atlas.min.css?api-version=2" type="text/css" />
    <script src="https://atlas.microsoft.com/sdk/js/atlas.min.js?api-version=2"></script>

    <!-- Add a reference to the Azure Maps Services Module JavaScript file. -->
    <script src="https://atlas.microsoft.com/sdk/js/atlas-service.js?api-version=2"></script>

    <!-- <script type="text/javascript" src="../JS/homepage.js"> </script> -->
    <script>
    // var map, datasource, client;


    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(GetMap);
    }
    else {
         alert("Geolocation is not supported by this browser.");
    }


    // function showPosition(position) {
    //   x.innerHTML = "Latitude: " + position.coords.latitude +
    //   "<br>Longitude: " + position.coords.longitude;
    // }

    function GetMap( position ) {
        // Create a new map
        var map = new atlas.Map("myMap", {
            //Add your Azure Maps subscription key to the map SDK. Get an Azure Maps key at https://azure.com/maps
            authOptions: {
                authType: 'subscriptionKey',
                subscriptionKey: 'yxBj4IKqdo6W7Hs9TDwIpMVUkiYRQXvMUdp5wBLKJqs'
            }
        });
        map.events.add("load", function () {
            // Add Traffic Flow to the Map

            /*map.setTraffic({
                flow: "relative"
            });
            */

            //Create a data source and add it to the map.
            datasource = new atlas.source.DataSource();
            map.sources.add(datasource);
            //Add a layer for rendering the route lines and have it render under the map labels.
            map.layers.add(new atlas.layer.LineLayer(datasource, null, {
                strokeColor: ['get', 'strokeColor'],
                strokeWidth: ['get', 'strokeWidth'],
                lineJoin: 'round',
                lineCap: 'round',
                filter: ['==', '$type', 'LineString']
            }), 'labels');
            //Add a layer for rendering point data.
            map.layers.add(new atlas.layer.SymbolLayer(datasource, null, {
                iconOptions: {
                    image: ['get', 'icon'],
                    allowOverlap: true
                },
                textOptions: {
                    textField: ['get', 'title'],
                    offset: [0, 1.2]
                },
                filter: ['==', '$type', 'Point']
            }));
            //Create the GeoJSON objects which represent the start and end point of the route.

            // var startPoint = new atlas.data.Feature(new atlas.data.Point([position.coords.longitude, position.coords.latitude]), {
            var startPoint = {pin: new atlas.data.Feature(new atlas.data.Point([26.070248, 44.475976]), {
                title: 'You',
                icon: 'pin-blue'
            }),
            marker: new atlas.HtmlMarker({
                htmlContent: '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="37" viewBox="0 0 30 37" xml:space="preserve"><rect x="0" y="0" rx="8" ry="8" width="30" height="30" fill="{color}"/><polygon fill="{color}" points="10,29 20,29 15,37 10,29"/><text x="15" y="20" style="font-size:16px;font-family:arial;fill:#ffffff;" text-anchor="middle">{text}</text></svg>',
                text: "You",
                color: 'Purple',
                position: [26.070248, 44.475976],
                popup: new atlas.Popup({
                  content: '<a href="https://www.w3schools.com"> Masina 1 </a>',
                  pixelOffset: [0, -30]
                })
              })
            };

            //Create array with every Washing Point
            var washing_points = [];

            // var masina2 = new atlas.data.Feature(new atlas.data.Point([26.102194, 44.432511]), {
            washing_points.push({pin: new atlas.data.Feature(new atlas.data.Point([26.102194, 44.432511]), {
              title: 'Masina2',
              icon: 'pin-round-red'
            }),
            distance:0,
            marker: new atlas.HtmlMarker({
              htmlContent: '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="37" viewBox="0 0 30 37" xml:space="preserve"><rect x="0" y="0" rx="8" ry="8" width="30" height="30" fill="{color}"/><polygon fill="{color}" points="10,29 20,29 15,37 10,29"/><text x="15" y="20" style="font-size:16px;font-family:arial;fill:#ffffff;" text-anchor="middle">{text}</text></svg>',
              text: "2",
              color: 'Red',
                position: [26.102194, 44.432511],
                popup: new atlas.Popup({
                  content: '<a href="https://www.w3schools.com"> Masina 2</a>',
                  pixelOffset: [0, -30]
                })
              })
            });

            // washing_points.push({pin: new atlas.data.Feature(new atlas.data.Point([26.102194, 44.432511]), {
            //   title: 'Masina2',
            //   icon: 'pin-round-red'
            // }),distance:0});




            // var masina1 = new atlas.data.Feature(new atlas.data.Point([26.056066, 44.445172]), {
            washing_points.push({pin: new atlas.data.Feature(new atlas.data.Point([26.056066, 44.445172]), {
                title: 'Masina1',
                icon: 'pin-round-red'
            }),
            distance:0,
            marker: new atlas.HtmlMarker({
              htmlContent: '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="37" viewBox="0 0 30 37" xml:space="preserve"><rect x="0" y="0" rx="8" ry="8" width="30" height="30" fill="{color}"/><polygon fill="{color}" points="10,29 20,29 15,37 10,29"/><text x="15" y="20" style="font-size:16px;font-family:arial;fill:#ffffff;" text-anchor="middle">{text}</text></svg>',
              text: "1",
              color: 'Red',
                position: [26.056066, 44.445172],
                popup: new atlas.Popup({
                content: '<a href="../HTML/homepage.html"> Masina 1</a>',
                  pixelOffset: [0, -30]
                })
              })
            });
            /*washing_points[0].pin = new atlas.data.Feature(new atlas.data.Point([26.056066, 44.445172]), {
                title: 'Masina1',
                icon: 'pin-round-red'
            });*/


            washing_points.push({pin: new atlas.data.Feature(new atlas.data.Point([26.089901, 44.432660]), {
                title: 'Masina3',
                icon: 'pin-round-red'
            }),
            distance:0,
            marker: new atlas.HtmlMarker({
              htmlContent: '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="37" viewBox="0 0 30 37" xml:space="preserve"><rect x="0" y="0" rx="8" ry="8" width="30" height="30" fill="{color}"/><polygon fill="{color}" points="10,29 20,29 15,37 10,29"/><text x="15" y="20" style="font-size:16px;font-family:arial;fill:#ffffff;" text-anchor="middle">{text}</text></svg>',
              text: "3",
              color: 'Red',
                position: [26.089901, 44.432660],
                popup: new atlas.Popup({
                  content: '<a width="200" href="https://www.w3schools.com"> Masina 3</a>',
                  pixelOffset: [0, -30]
                })
              })});


            // Use SubscriptionKeyCredential with a subscription key
            var subscriptionKeyCredential = new atlas.service.SubscriptionKeyCredential(atlas.getSubscriptionKey());
            // Use subscriptionKeyCredential to create a pipeline
            var pipeline = atlas.service.MapsURL.newPipeline(subscriptionKeyCredential);
            // Construct the RouteURL object
            var routeURL = new atlas.service.RouteURL(pipeline);


            //Start and end point input to the routeURL
            // var washing_points_coords = [];

            routes_promises = [];


            for(let i = 0; i < washing_points.length; i++){
              washing_points[i].coords = [[startPoint.pin.geometry.coordinates[0], startPoint.pin.geometry.coordinates[1]], [washing_points[i].pin.geometry.coordinates[0], washing_points[i].pin.geometry.coordinates[1]]];
              routes_promises[i] = routeURL.calculateRouteDirections(atlas.service.Aborter.timeout(10000), washing_points[i].coords);
            }

            // Calculate every route to washing points and save distance
            Promise.all(routes_promises).then((directions) => {
              for(let i = 0; i < washing_points.length; i++){
                washing_points[i].distance = directions[i].routes[0].summary.lengthInMeters;
                washing_points[i].directions = directions[i];
              }
              console.log(washing_points[0].distance);
              console.log(washing_points);
              //Sort washing points by shortest distance
              washing_points.sort(function(a, b){ return b.distance - a.distance});
              console.log(washing_points[0].distance);
              console.log(washing_points);

              for(let i = washing_points.length - 1; i >= 0; i--){
                //Get data features from response
                var data = washing_points[i].directions.geojson.getFeatures();
                //Get the route line and add some style properties to it.
                var routeLine = data.features[0];
                if(i == 0) {
                  // Shortest path
                  routeLine.properties.strokeColor = '#f02e15';
                } else {
                  // Other paths
                  routeLine.properties.strokeColor = '#2272B9';
                }
                console.log(routeLine);
                routeLine.properties.strokeWidth = 5;
                //Add the route line to the data source. We want this to render below the car route which will likely be added to the data source faster, so insert it at index 0.
                datasource.add(routeLine);
              }

              //Fit the map window to the bounding box defined by the start and end positions.
              map.setCamera({
                  bounds: atlas.data.BoundingBox.fromData([startPoint.pin, washing_points[washing_points.length-1].pin]),
                  padding: 100
              });

              //Add the data to the data source.

              //datasource.add(startPoint);
              map.markers.add(startPoint.marker);
              for(let i = 0; i < washing_points.length; i++){
                map.markers.add(washing_points[i].marker);
                // Activate Pop-UP on marker click
                map.events.add('click',washing_points[i].marker, () => {
                washing_points[i].marker.togglePopup();
                });
                //datasource.add(washing_points[i].pin);
              }

            });



        });
    }

     </script>

    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        #myMap {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body onload="GetMap()">
    <div id="myMap" style="position: relative; margin-left: auto; margin-right: auto; bottom:0;  width: 1500px; height: 500px"></div>
</body>

</html>
